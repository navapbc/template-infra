tf-rds-aurora

Creates an RDS Aurora Cluster with instances.

Note: a random master password is set then ignored by terraform, the expectation  
is that you set that password out-of-band. This was done to avoid the password  
being tracked in terraform state.

Once a db is provisioned, you should:  
1. run terraform/modules/tf-rds-aurora/update\_master\_password.sh (see script for details)  
2. run bin/setup\_postgres\_roles.sh (see script for details)

Also note: CMS Clouds scans an RDS instances for ARS compliance, so see the firewall rule below

## Requirements

No requirements.

## Providers

| Name   | Version |
| ------ | ------- |
| aws    | n/a     |
| null   | n/a     |
| random | n/a     |

## Modules

| Name                   | Source                     | Version |
| ---------------------- | -------------------------- | ------- |
| cms\_network\_metadata | ../../cms_network_metadata | n/a     |

## Resources

| Name                                                                                                                                                      | Type        |
| --------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| [aws_cloudwatch_metric_alarm.reader_cpu_utilization](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource    |
| [aws_cloudwatch_metric_alarm.reader_db_connections](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm)  | resource    |
| [aws_cloudwatch_metric_alarm.replica_lag](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm)            | resource    |
| [aws_cloudwatch_metric_alarm.writer_cpu_utilization](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource    |
| [aws_cloudwatch_metric_alarm.writer_db_connections](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm)  | resource    |
| [aws_db_subnet_group.rds_subnet_group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_subnet_group)                       | resource    |
| [aws_rds_cluster.rds_aurora_cluster](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/rds_cluster)                             | resource    |
| [aws_rds_cluster_instance.cluster_instances](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/rds_cluster_instance)            | resource    |
| [aws_rds_cluster_parameter_group.cluster](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/rds_cluster_parameter_group)        | resource    |
| [aws_secretsmanager_secret.db_password](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/secretsmanager_secret)                | resource    |
| [aws_security_group.rds_security_group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group)                       | resource    |
| [null_resource.update_rds_password](https://registry.terraform.io/providers/hashicorp/null/latest/docs/resources/resource)                                | resource    |
| [random_string.temporary_password](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/string)                                 | resource    |
| [aws_region.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/region)                                               | data source |

## Inputs

| Name                                     | Description                                                                                                                                                                                                                                                                                                                                                        | Type                                                                                                            | Default                                                                                                                                                                              | Required |
| ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :------: |
| allow\_cbj\_access                       | Indicates whether the Cloudbees Jenkins CIDR should be added to the allowed to access. This could be useful for for DB schema migrations (i.e. Flyway).                                                                                                                                                                                                            | `bool`                                                                                                          | `false`                                                                                                                                                                              |    no    |
| application\_name                        | The name of the application                                                                                                                                                                                                                                                                                                                                        | `string`                                                                                                        | n/a                                                                                                                                                                                  |   yes    |
| backup\_retention\_period                | The backup retention period in days                                                                                                                                                                                                                                                                                                                                | `string`                                                                                                        | n/a                                                                                                                                                                                  |   yes    |
| cloudwatch\_notification\_arn            | The notification ARN to send CloudWatch alarms                                                                                                                                                                                                                                                                                                                     | `string`                                                                                                        | n/a                                                                                                                                                                                  |   yes    |
| cluster\_parameters                      | Map of parameters to attach to cluster parameter group. Format should be     {       param1 = {         value = "bar",         apply\_method = "pending-reboot"       }        param2 = {         value = "foo"       }     }      default apply\_method is "immediate" if null.                                                                                   | `map`                                                                                                           | `{}`                                                                                                                                                                                 |    no    |
| database\_name                           | The name of the DB to create. Leaving the name as an empty string will create an RDS instance without a specific DB. See https://www.terraform.io/docs/providers/aws/r/db_instance.html#name for more detail                                                                                                                                                       | `string`                                                                                                        | `""`                                                                                                                                                                                 |    no    |
| db\_port                                 | The port the db uses.                                                                                                                                                                                                                                                                                                                                              | `string`                                                                                                        | n/a                                                                                                                                                                                  |   yes    |
| enable\_pg\_cron                         | Enable pg\_cron\_plugin for Aurora database                                                                                                                                                                                                                                                                                                                        | `bool`                                                                                                          | `false`                                                                                                                                                                              |    no    |
| enabled\_cloudwatch\_logs\_exports       | The set of log types to export to Cloudwatch                                                                                                                                                                                                                                                                                                                       | `list(any)`                                                                                                     | ```[ "postgresql" ]```                                                                                                                                                               |    no    |
| engine                                   | The database engine                                                                                                                                                                                                                                                                                                                                                | `string`                                                                                                        | n/a                                                                                                                                                                                  |   yes    |
| engine\_version                          | The database engine version                                                                                                                                                                                                                                                                                                                                        | `string`                                                                                                        | n/a                                                                                                                                                                                  |   yes    |
| environment\_name                        | n/a                                                                                                                                                                                                                                                                                                                                                                | `any`                                                                                                           | n/a                                                                                                                                                                                  |   yes    |
| iam\_database\_authentication\_enabled   | Specifies whether or mappings of AWS Identity and Access Management (IAM) accounts to database accounts is enabled                                                                                                                                                                                                                                                 | `bool`                                                                                                          | `true`                                                                                                                                                                               |    no    |
| ingress\_cidrs                           | List of cidrs allowed access to cluster                                                                                                                                                                                                                                                                                                                            | `list(any)`                                                                                                     | `[]`                                                                                                                                                                                 |    no    |
| instance\_class                          | The instance type of the RDS instance                                                                                                                                                                                                                                                                                                                              | `string`                                                                                                        | n/a                                                                                                                                                                                  |   yes    |
| instance\_count                          | Number of DB instances for the Aurora cluster                                                                                                                                                                                                                                                                                                                      | `number`                                                                                                        | `1`                                                                                                                                                                                  |    no    |
| log\_forwarding\_enabled                 | Flag to toggle whether to forward logs                                                                                                                                                                                                                                                                                                                             | `bool`                                                                                                          | `true`                                                                                                                                                                               |    no    |
| master\_username                         | The username for the master DB user.                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                        | n/a                                                                                                                                                                                  |   yes    |
| parameter\_group\_name\_override         | The name of the parameter group created in this module (default is the same as the DB cluster name)                                                                                                                                                                                                                                                                | `string`                                                                                                        | `""`                                                                                                                                                                                 |    no    |
| performance\_insights\_enabled           | Specifies whether performance Insight is enabled                                                                                                                                                                                                                                                                                                                   | `bool`                                                                                                          | `false`                                                                                                                                                                              |    no    |
| performance\_insights\_retention\_period | The retention period of performance insight data                                                                                                                                                                                                                                                                                                                   | `string`                                                                                                        | `7`                                                                                                                                                                                  |    no    |
| reader\_cpu\_utilization                 | Parameters for reader\_cpu\_utilization Cloudwatch metric alarm                                                                                                                                                                                                                                                                                                    | `map(any)`                                                                                                      | ```{ "comparison_operator": "GreaterThanOrEqualToThreshold", "datapoints_to_alarm": null, "evaluation_periods": "2", "period": "300", "statistic": "Average", "threshold": "90" }``` |    no    |
| restore\_to\_point\_in\_time             | If provided, creates a brand new cloned copy of the cluster, at the specified point in time.     Example:       restore\_to\_point\_in\_time = {         restore\_to\_time            = "2022-10-11T16:00:00Z"         source\_cluster\_identifier  = module.mpsmcd\_2616\_rds\_aurora.cluster\_resource\_id         use\_latest\_restorable\_time = false       } | ```object({ restore_to_time = string source_cluster_identifier = string use_latest_restorable_time = bool })``` | `null`                                                                                                                                                                               |    no    |
| security\_group\_ids                     | Security groups permitted to access RDS.                                                                                                                                                                                                                                                                                                                           | `list(any)`                                                                                                     | `[]`                                                                                                                                                                                 |    no    |
| serverlessv2\_scaling\_configuration     | If provided, will create a Serverless V2 cluster, or convert an existing cluster to Serverless V2.     Example:       serverlessv2\_scaling\_configuration = {         max\_capacity  = 128.0         min\_capacity  = 0.5       }                                                                                                                                 | ```object({ max_capacity = number min_capacity = number })```                                                   | `null`                                                                                                                                                                               |    no    |
| snapshot\_identifier                     | Specifies whether or not to create this database from a snapshot. This correlates to the snapshot ID you'd find in the RDS console, e.g: rds:production-2015-06-26-06-05.                                                                                                                                                                                          | `string`                                                                                                        | `""`                                                                                                                                                                                 |    no    |
| subnet\_ids                              | List of DB subnet group. DB instance will be created in the VPC associated with the DB subnet group                                                                                                                                                                                                                                                                | `list(any)`                                                                                                     | n/a                                                                                                                                                                                  |   yes    |
| update\_password                         | Whether to update the master password when instance is created                                                                                                                                                                                                                                                                                                     | `bool`                                                                                                          | `true`                                                                                                                                                                               |    no    |
| vpc\_id                                  | n/a                                                                                                                                                                                                                                                                                                                                                                | `any`                                                                                                           | n/a                                                                                                                                                                                  |   yes    |
| vpc\_name                                | n/a                                                                                                                                                                                                                                                                                                                                                                | `any`                                                                                                           | n/a                                                                                                                                                                                  |   yes    |
| writer\_cpu\_utilization                 | Parameters for writer\_cpu\_utilization Cloudwatch metric alarm                                                                                                                                                                                                                                                                                                    | `map(any)`                                                                                                      | ```{ "comparison_operator": "GreaterThanOrEqualToThreshold", "datapoints_to_alarm": null, "evaluation_periods": "2", "period": "300", "statistic": "Average", "threshold": "90" }``` |    no    |

## Outputs

| Name                   | Description                                                  |
| ---------------------- | ------------------------------------------------------------ |
| cluster\_resource\_arn | The RDS cluster's ARN                                        |
| cluster\_resource\_id  | The region-unique, immutable identifier for the RDS cluster. |
| endpoint               | The endpoint of the RDS instance                             |
| endpoint\_read\_only   | The read-only endpoint of the RDS instance                   |

# Aurora Serverless V2
Even though this module creates dedicated Aurora cluster instances by default, it does provide the option to deploy Aurora Serverless V2 instances.

To do that, the `serverlessv2_scaling_configuration` attribute has to be defined, which contains the following keys (enforced by this module):

```
 serverlessv2_scaling_configuration = {
    max_capacity = 8.0
    min_capacity = 0.5
  }
```
This module does not support creating a mix of regular and serverless instance types.

Refer to [this document](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-serverless-v2.create-cluster.html) for more details on how Aurora Serverless v2 works and the appropriate capacity settings for your databases.

# Point-in-time restore details

Similar to specifying an RDS snapshot on an instance, supplying point-in-time configuration will create a brand new cluster reflecting the referenced data. In order to handle future failover needs gracefully, this config is ignored on future terraform operations. It is only applicable to brand new resources. 

Failing over/rolling back a cluster is a 3-step process:
1. Create a new cluster with point-in-time configuration referencing your old, existing cluster
2. Update your application to reference the new cluster
3. Cleanup the old cluster, and your point-in-time config

### Create a New Cluster
Copy+paste your existing `module "<your block name>" {` Aurora module invocation block. You must then rename the block itself, the `application_name`, and the `parameter_group_name_override` if specified. Remove `snapshot_identifier` if it was used, this is mutually exclusive with point-in-time restoration.

Add a `restore_to_point_in_time` input, which contains the following keys (enforced by this module):
```js
restore_to_point_in_time = {
     restore_to_time = "2023-02-01T20:30:00Z" // "February 01, 2023, 14:30 (UTC-06:00)"
     source_cluster_identifier = module.<old_Aurora_module_name>.cluster_resource_arn
     use_latest_restorable_time = false
   }
```
The `source_cluster_identifier` should be set to the ARN output from your old cluster. Either `restore_to_time` should be null **or** `use_latest_restorable_time` should be false, they are mutually exclusive. The format of the time string is in UTC format as demonstrated here. The cluster's earliest and latest restorable times can be seen in the AWS console or by [describe-db-clusters](https://docs.aws.amazon.com/cli/latest/reference/rds/describe-db-clusters.html) CLI command, and will follow the old cluster's retention period policy. 

Lastly, in order to expose the new cluster's address to your application, update your component's `output.tf` to reference the address of the new Aurora module's cluster instead of the old. 

### Repoint Your Application
Once your updated database component has been `terraform apply`'d successfully, the database component's terraform state will be providing the new cluster's address. Re-apply your _application's_ terraform component, so it can discover and rollout this new value in its environment variables. Validate the DB state change in your app once it's finished the rollout.

### Cleanup
Depending on the circumstances, it may take some time and testing to get satisfied with the new, rolled-back cluster. Once things are settled down again and you're ready to resume normal operations, the old Aurora cluster should be cleaned up. 

Remove the old module invocation. Because your new cluster's `restore_to_point_in_time.source_cluster_identifier` references that, you'll need to also remove the entire `restore_to_point_in_time` input. This is ignored by our terraform module, so doing so should result in no changes to your new cluster, but it's never a bad idea to check the terraform plan just in case. 

The old RDS Aurora cluster will also have deletion protection enabled. An OSRE member will need to manually disable that via CLI or console before Terraform will be to successfully tear it down.tf-rds-aurora

Creates an RDS Aurora Cluster with instances.

Note: a random master password is set then ignored by terraform, the expectation
is that you set that password out-of-band. This was done to avoid the password
being tracked in terraform state.

Once a db is provisioned, you should:
1. run terraform/modules/tf-rds-aurora/update\_master\_password.sh (see script for details)
2. run bin/setup\_postgres\_roles.sh (see script for details)

Also note: CMS Clouds scans an RDS instances for ARS compliance, so see the firewall rule below

